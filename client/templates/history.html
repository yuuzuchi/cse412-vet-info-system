<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History Display</title>
    <link rel="stylesheet" href="history.css">
</head>
<body>
    <div class="history-container">
        <div class="history-header">
            Animal History Records
        </div>

        <!-- Search bar  -->
        <div style="padding: 10px;">
            
            <input
                type="text"
                id="searchInput"
                placeholder="Search by Name, Species, or Last Name..."
                style="padding: 5px; width: 100%; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
            />
        </div>

        <!-- Animal Table structure -->
        <div class="history-content">
            <table id="animalTable" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px;">ID</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Name</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Last Name</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Species</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Date of Birth</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Case Details Container -->
    <div class="case-details-container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 id="caseDetailsTitle" style="color: #333; font-size: 20px; margin-bottom: 10px;">
                Patient Case Details
            </h2>
            <button id="addHistoryButton" style="padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Add New Record
            </button>
        </div>
        <table id="caseTable" style="width: 100%; border-collapse: collapse; margin-top: 10px; display: none;">
            <thead>
                <tr>
                    <th>Case ID</th>
                    <th>Animal ID</th>
                    <th>Date Visit</th>
                    <th>Reason</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be dynamically inserted here -->
            </tbody>
        </table>
    </div>

    <!-- Add New History Modal -->
    <div id="addHistoryModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000; width: 400px;">
        <h3 style="text-align: center; margin-top: 0;">Add New History</h3>
        <form id="addHistoryForm">
            <div>
                <label for="dateVisit">Date of Visit:</label>
                <input type="date" id="dateVisit" name="date_visit" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div id="speciesSpecificFields">
                <!-- Dynamically added fields based on species -->
            </div>
            <button type="submit" style="width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Submit
            </button>
        </form>
        <button onclick="closeAddHistoryModal()" style="width: 100%; display: block; margin: 10px auto 0; padding: 10px 20px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer;">
            Close
        </button>
    </div>
    <div id="addHistoryOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;" onclick="closeAddHistoryModal()"></div>

    
    <!-- view case modal -->
    <div id="caseModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000; width: 400px;">
        <button id="closeModalButton" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
        <h3 id="modalTitle" style="margin-top: 0; text-align: center;">Case Details</h3>
        <div id="modalContent" style="margin-top: 10px; font-size: 14px; line-height: 1.6;">
        </div>
        <button id="deleteButton" style="display: block; margin: 20px auto 0; padding: 10px 20px; border: none; background: #dc3545; color: white; border-radius: 5px; cursor: pointer;">Delete</button>
    </div>
    <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;" onclick="closeModal()"></div>

    <script>
        // Global functions for case handling
        function setupCaseTable(data, species) {
            const caseTableBody = document.querySelector("#caseTable tbody");
            caseTableBody.innerHTML = '';

            if (data.length === 0) {
                caseTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 10px;">No cases found for this patient.</td>
                    </tr>
                `;
                return;
            }

            data.forEach(caseItem => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${caseItem.Case_id}</td>
                    <td>${caseItem.Animal_id}</td>
                    <td>${caseItem.Date_visit || 'Unknown'}</td>
                    <td>${caseItem.Reason_visit || 'Unknown'}</td>
                `;

                row.addEventListener('click', async () => {
                    // Fetch detailed case information
                    fetchCaseDetails(caseItem.Case_id, species);
                });

                caseTableBody.appendChild(row);
            });
        }

        async function fetchAnimalCases(animal_id, species, name) {
            try {
                const response = await fetch(`http://localhost:5000/history?animal_id=${animal_id}&species=${species}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                const caseTable = document.getElementById("caseTable");
                const caseDetailsTitle = document.getElementById("caseDetailsTitle");

                caseDetailsTitle.textContent = `Patient Case Details: ${name}`;
                
                // Ensure data is an array before passing to setupCaseTable
                const casesArray = Array.isArray(data) ? data : [];
                setupCaseTable(casesArray, species);
                caseTable.style.display = 'table';
            } catch (error) {
                console.error('Error fetching case history:', error);
                const caseTableBody = document.querySelector("#caseTable tbody");
                caseTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 10px; color: red;">
                            Error loading case history. Please try again.
                        </td>
                    </tr>
                `;
                document.getElementById("caseTable").style.display = 'table';
            }
        }

        // Fetch data and populate the table
        async function fetchAnimalList(vet_id = 1) {
            try {
                const response = await fetch(`http://localhost:5000/animal-list?vet_id=${vet_id}`);
                const data = await response.json();

                const tableBody = document.querySelector("#animalTable tbody");

                // Clear any existing rows
                tableBody.innerHTML = '';

                if (data.length === 0) {
                    const noRecordsRow = document.createElement('tr');
                    noRecordsRow.innerHTML = `
                        <td colspan="5" style="text-align: center; padding: 10px;">No records found.</td>
                    `;
                    tableBody.appendChild(noRecordsRow);
                    return;
                }

                // Populate rows for each animal
                data.forEach(animal => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="border: 1px solid #ddd; padding: 8px;">${animal.animal_id}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${animal.name}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${animal.last_name}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${animal.species}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${animal.dob || 'Unknown'}</td>
                    `;

                    // Add a data attribute for search filtering
                    row.dataset.animal_id = animal.animal_id.toString();
                    row.dataset.name = animal.name.toLowerCase();
                    row.dataset.lastName = animal.last_name.toLowerCase();
                    row.dataset.species = animal.species.toLowerCase();
                    
                    row.addEventListener('click', () => {
                        document.querySelectorAll('#animalTable tbody tr').forEach(r => r.classList.remove('highlight'));
                        row.classList.add('highlight');
                         fetchAnimalCases(animal.animal_id, animal.species, animal.name);
                    });

                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error fetching animal list:', error);
                const tableBody = document.querySelector("#animalTable tbody");
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 10px; color: red;">
                            Error loading records. Please try again later.
                        </td>
                    </tr>
                `;
            }
        }

        document.getElementById('deleteButton').addEventListener('click', async () => {
            const modalContent = document.getElementById('modalContent');

            // Extract `case_id` and `species` from modal content or highlighted row
            const selectedRow = document.querySelector('.highlight');
            if (!selectedRow) {
                alert("Please select an animal and view its cases to delete.");
                return;
            }

            const species = selectedRow.dataset.species.toLowerCase(); // Extract species
            const caseId = modalContent.dataset.case_id; // Assume `case_id` is stored in the modal

            if (!species || !caseId) {
                alert("Unable to identify the record to delete.");
                return;
            }

            // Confirm deletion
            if (!confirm(`Are you sure you want to delete Case ID: ${caseId} (${species})?`)) {
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/delete-history', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ species, case_id: caseId }),
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    closeModal(); // Close the modal after successful deletion
                    fetchAnimalCases(selectedRow.dataset.animal_id, species); // Refresh the case list
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                console.error("Error deleting record:", error);
                alert("An error occurred while deleting the record. Please try again.");
            }
        });


        function showModal(content, caseId) {
            const modal = document.getElementById('caseModal');
            const modalContent = document.getElementById('modalContent');

            // Store case_id in modalContent's dataset
            modalContent.dataset.case_id = caseId;

            // Set the modal content
            modalContent.innerHTML = content;

            modal.style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }



        document.getElementById('closeModalButton').addEventListener('click', closeModal);
        function closeModal() {
            const modal = document.getElementById('caseModal');
            const overlay = document.getElementById('modalOverlay');

            if (modal) modal.style.display = 'none';
            if (overlay) overlay.style.display = 'none';
        }


        async function fetchCaseDetails(case_id, species) {
            console.log("Fetching details for Case ID:", case_id, "Species:", species);
            try {
                const response = await fetch(`http://localhost:5000/case-details?case_id=${case_id}&species=${species}`);
                const data = await response.json();

                if (data.error) {
                    showModal(`<p style="color: red;">${data.error}</p>`);
                    return;
                }

                // 格式化显示信息
                const modalContentHtml = Object.entries(data)
                    .map(([key, value]) => `<p><strong>${key.replace('_', ' ')}:</strong> ${value || 'Unknown'}</p>`)
                    .join('');
                
                // Call showModal with the updated content
                showModal(modalContentHtml, case_id);
            } catch (error) {
                console.error('Error fetching case details:', error);
                showModal('<p style="color: red;">Error fetching case details. Please try again later.</p>');
            }
        }

        // Setup search functionality
        function setupSearchFilter() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', () => {
                const filter = searchInput.value.toLowerCase();
                const rows = document.querySelectorAll('#animalTable tbody tr');

                rows.forEach(row => {
                    // Check if the search term matches any column value
                    const matches = row.dataset.animal_id.includes(filter) ||
                                    row.dataset.name.includes(filter) ||
                                    row.dataset.lastName.includes(filter) ||
                                    row.dataset.species.includes(filter);

                    // Show or hide rows based on the match
                    row.style.display = matches ? '' : 'none';
                });
            });
        }

        document.getElementById('addHistoryButton').addEventListener('click', () => {
            const selectedRow = document.querySelector('.highlight');
            if (!selectedRow) {
                alert("Please select an animal to add history.");
                return;
            }

            const animalId = selectedRow.dataset.animal_id;
            const species = selectedRow.dataset.species;

            // Open the modal
            document.getElementById('addHistoryModal').style.display = 'block';
            document.getElementById('addHistoryOverlay').style.display = 'block';

            // Populate species-specific fields
            populateSpeciesSpecificFields(species, animalId);

            // Set hidden animal_id and vet_id fields
            document.getElementById('addHistoryForm').dataset.animal_id = animalId; // Dynamic assignment
            document.getElementById('addHistoryForm').dataset.vet_id = 1; // Example vet_id
        });

        // Close Add History Modal
        function closeAddHistoryModal() {
            document.getElementById('addHistoryModal').style.display = 'none';
            document.getElementById('addHistoryOverlay').style.display = 'none';
            document.getElementById('speciesSpecificFields').innerHTML = ''; // Clear dynamic fields
        }

        // Populate species-specific fields
        function populateSpeciesSpecificFields(species, animalId) {
            const speciesFieldsContainer = document.getElementById('speciesSpecificFields');
            let speciesFields = '';

            switch (species.toLowerCase()) {
                case 'dog':
                    speciesFields = `
                        <div>
                            <label for="weight">Weight (lb):</label>
                            <input type="number" id="weight" name="weight" step="0.01" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="exerciseLevel">Exercise Level:</label>
                            <input type="text" id="exerciseLevel" name="exercise_level" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="foodPassion">Food Passion:</label>
                            <input type="text" id="foodPassion" name="food_passion" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="sterilization">Sterilization (Yes/No):</label>
                            <select id="sterilization" name="sterilization" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div>
                            <label for="reasonVisit">Reason for Visit:</label>
                            <textarea id="reasonVisit" name="reason_visit" rows="2" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                        <div>
                            <label for="comment">Comment:</label>
                            <textarea id="comment" name="comment" rows="3" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>

                    `;
                    break;
                case 'cat':
                    speciesFields = `
                        <div>
                            <label for="weight">Weight (lb):</label>
                            <input type="number" id="weight" name="weight" step="0.01" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="foodPassion">Food Passion:</label>
                            <input type="text" id="foodPassion" name="food_passion" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        
                        <div>
                            <label for="inOutdoor">Indoor/Outdoor:</label>
                            <select id="inOutdoor" name="in_outdoor" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="true">Indoor</option>
                                <option value="false">Outdoor</option>
                            </select>
                        </div>
                        <div>
                            <label for="sterilization">Sterilized (Yes/No):</label>
                            <select id="sterilization" name="sterilization" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div>
                            <label for="reasonVisit">Reason for Visit:</label>
                            <textarea id="reasonVisit" name="reasonVisit" rows="2" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                        <div>
                            <label for="comment">Comment:</label>
                            <textarea id="comment" name="comment" rows="3" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                    `;
                    break;
                case 'bird':
                    speciesFields = `
                        <div>
                            <label for="weight">Weight (lb):</label>
                            <input type="number" id="weight" name="weight" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="wingspan">Wingspan (cm):</label>
                            <input type="number" id="wingspan" name="wingspan" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="flyingCapacity">Flying Capacity:</label>
                            <input type="text" id="flyingCapacity" name="flyingCapacity" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="wingclip">Wing Clip (Yes/No):</label>
                            <select id="wingclip" name="wingclip" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="cageOnly">Cage Only (Yes/No):</label>
                            <select id="cageOnly" name="cage_only" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div>
                            <label for="reasonVisit">Reason for Visit:</label>
                            <textarea id="reasonVisit" name="reasonVisit" rows="2" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                        <div>
                            <label for="comment">Comment:</label>
                            <textarea id="comment" name="comment" rows="3" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                    `;
                    break;
                case 'reptile':
                    speciesFields = `
                        <div>
                            <label for="length">Length (cm):</label>
                            <input type="number" id="length" name="length" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="weight">Weight (lb):</label>
                            <input type="number" id="weight" name="weight" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="housingType">Housing Type:</label>
                            <input type="text" id="housingType" name="housing_type" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="temperatureKeep">Temperature (°C):</label>
                            <input type="number" id="temperatureKeep" name="temperatureKeep" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="humidityKeep">Humidity Keep (%):</label>
                            <input type="number" id="humidityKeep" name="humidity_keep" step="1" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="reasonVisit">Reason for Visit:</label>
                            <textarea id="reasonVisit" name="reasonVisit" rows="2" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                        <div>
                            <label for="comment">Comment:</label>
                            <textarea id="comment" name="comment" rows="3" required style="width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                        </div>
                    `;
                    break;
                default:
                    speciesFields = `<p style="color: red;">Unsupported species: ${species}</p>`;
            }

            speciesFieldsContainer.innerHTML = speciesFields;
        }

        // Handle form submission
        document.getElementById('addHistoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectedRow = document.querySelector('.highlight');
            if (!selectedRow) {
                alert('Please select an animal before submitting.');
                return;
            }

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const species = selectedRow.dataset.species.toLowerCase();
            data.animal_id = selectedRow.dataset.animal_id;
            data.vet_id = 1;

            console.log('Submitting data:', { ...data, species }); // Debug log

            try {
                const response = await fetch('http://localhost:5000/add-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ ...data, species }),
                });

                console.log('Response status:', response.status); // Debug log
                const result = await response.json();
                console.log('Response data:', result); // Debug log

                if (response.ok) {
                    alert(result.message);
                    closeAddHistoryModal();
                    // Get the name from the selected row
                    const name = selectedRow.dataset.name;
                    await fetchAnimalCases(data.animal_id, species, name);
                } else {
                    throw new Error(result.error || 'Failed to add history');
                }
            } catch (error) {
                console.error('Error details:', error);
                alert('An error occurred while adding history. Please try again later.');
            }
        });

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            fetchAnimalList(1);
        });
    </script>
</body>
</html>